{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.TransactionCompletionStrategyOnAPI = exports.TransactionCompletionStrategyOnProxy = void 0;\n\nconst primitives_1 = require(\"./primitives\");\n\nconst WellKnownCompletionEvents = [\"completedTxEvent\", \"SCDeploy\", \"signalError\"];\n/**\n * Algorithm for detecting transaction completion.\n * Based on some heuristics (a bit imprecise therefore, at this moment).\n */\n\nclass TransactionCompletionStrategyOnProxy {\n  isCompleted(transaction) {\n    if (transaction.status.isPending()) {\n      // Certainly not completed.\n      return false;\n    } // Handle gateway mechanics:\n\n\n    for (const completionEvent of WellKnownCompletionEvents) {\n      if (transaction.logs.findFirstOrNoneEvent(completionEvent)) {\n        // Certainly completed.\n        console.debug(\"TransactionCompletionStrategy.isCompleted(), found event:\", completionEvent);\n        return true;\n      }\n    }\n\n    if (this.isCertainlyMoveBalance(transaction.data)) {\n      return transaction.status.isExecuted();\n    }\n\n    let hyperblockNonce = transaction.hyperblockNonce; // Imprecise condition, uncertain completion (usually sufficient, though).\n    // This is WRONG when (at least): timeOf(block with execution at destination is notarized) < timeOf(the \"completedTxEvent\" occurs).\n\n    if (hyperblockNonce > 0) {\n      console.debug(\"TransactionCompletionStrategy.isCompleted(), found hyperblock nonce:\", hyperblockNonce);\n      return true;\n    }\n\n    return false;\n  }\n\n  isCertainlyMoveBalance(transactionData) {\n    let parts = transactionData.toString().split(\"@\");\n    let prefix = parts[0];\n    let otherParts = parts.slice(1);\n    let emptyPrefix = !prefix;\n    let somePartsAreNotValidArguments = !otherParts.every(part => this.looksLikeValidArgument(part));\n    return emptyPrefix || somePartsAreNotValidArguments;\n  }\n\n  looksLikeValidArgument(arg) {\n    return primitives_1.isPaddedHex(arg);\n  }\n\n}\n\nexports.TransactionCompletionStrategyOnProxy = TransactionCompletionStrategyOnProxy;\n\nclass TransactionCompletionStrategyOnAPI {\n  isCompleted(transaction) {\n    return !transaction.status.isPending();\n  }\n\n}\n\nexports.TransactionCompletionStrategyOnAPI = TransactionCompletionStrategyOnAPI;","map":{"version":3,"mappings":";;;;;;;AAEA;;AASA,MAAMA,yBAAyB,GAAG,CAAC,kBAAD,EAAqB,UAArB,EAAiC,aAAjC,CAAlC;AAEA;;;;;AAIA,MAAaC,oCAAb,CAAiD;EAC7CC,WAAW,CAACC,WAAD,EAAmC;IAC1C,IAAIA,WAAW,CAACC,MAAZ,CAAmBC,SAAnB,EAAJ,EAAoC;MAChC;MACA,OAAO,KAAP;IACH,CAJyC,CAM1C;;;IACA,KAAK,MAAMC,eAAX,IAA8BN,yBAA9B,EAAyD;MACrD,IAAIG,WAAW,CAACI,IAAZ,CAAiBC,oBAAjB,CAAsCF,eAAtC,CAAJ,EAA4D;QACxD;QACAG,OAAO,CAACC,KAAR,CAAc,2DAAd,EAA2EJ,eAA3E;QACA,OAAO,IAAP;MACH;IACJ;;IAED,IAAI,KAAKK,sBAAL,CAA4BR,WAAW,CAACS,IAAxC,CAAJ,EAAmD;MAC/C,OAAOT,WAAW,CAACC,MAAZ,CAAmBS,UAAnB,EAAP;IACH;;IAED,IAAIC,eAAe,GAAGX,WAAW,CAACW,eAAlC,CAnB0C,CAqB1C;IACA;;IACA,IAAIA,eAAe,GAAG,CAAtB,EAAyB;MACrBL,OAAO,CAACC,KAAR,CAAc,sEAAd,EAAsFI,eAAtF;MACA,OAAO,IAAP;IACH;;IAED,OAAO,KAAP;EACH;;EAEOH,sBAAsB,CAACI,eAAD,EAAwB;IAClD,IAAIC,KAAK,GAAGD,eAAe,CAACE,QAAhB,GAA2BC,KAA3B,CAAiC,GAAjC,CAAZ;IACA,IAAIC,MAAM,GAAGH,KAAK,CAAC,CAAD,CAAlB;IACA,IAAII,UAAU,GAAGJ,KAAK,CAACK,KAAN,CAAY,CAAZ,CAAjB;IACA,IAAIC,WAAW,GAAG,CAACH,MAAnB;IACA,IAAII,6BAA6B,GAAG,CAACH,UAAU,CAACI,KAAX,CAAiBC,IAAI,IAAI,KAAKC,sBAAL,CAA4BD,IAA5B,CAAzB,CAArC;IAEA,OAAOH,WAAW,IAAIC,6BAAtB;EACH;;EAEOG,sBAAsB,CAACC,GAAD,EAAY;IACtC,OAAOC,yBAAYD,GAAZ,CAAP;EACH;;AA5C4C;;AAAjDE;;AA+CA,MAAaC,kCAAb,CAA+C;EAC3C5B,WAAW,CAACC,WAAD,EAAmC;IAC1C,OAAO,CAACA,WAAW,CAACC,MAAZ,CAAmBC,SAAnB,EAAR;EACH;;AAH0C;;AAA/CwB","names":["WellKnownCompletionEvents","TransactionCompletionStrategyOnProxy","isCompleted","transaction","status","isPending","completionEvent","logs","findFirstOrNoneEvent","console","debug","isCertainlyMoveBalance","data","isExecuted","hyperblockNonce","transactionData","parts","toString","split","prefix","otherParts","slice","emptyPrefix","somePartsAreNotValidArguments","every","part","looksLikeValidArgument","arg","primitives_1","exports","TransactionCompletionStrategyOnAPI"],"sourceRoot":"","sources":["../src/transactionCompletionStrategy.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}